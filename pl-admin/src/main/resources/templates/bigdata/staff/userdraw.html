<!DOCTYPE HTML>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<meta charset="utf-8">
<script th:src="@{../../plugins/echars/js/echarts-all.js}"></script>
<head th:include="include :: header"></head>
<style>
    .fixed-table-pagination{display: none !important;}
</style>
<body class="gray-bg">
    
     <div class="container-div">
		<div class="row">
			<div class="col-sm-12 search-collapse" style="padding-bottom: 0px;">
				<form id="formId">
					<div class="select-list">
                        <div class="col-sm-11">
                            <ul>
                                <div class="col-sm-12">
                                    <li class="col-sm-3">
                                        部门：
                                        <select name="department" id="department" class="m-b">
                                            <option>全部</option>
                                        </select>
                                    </li>
                                    <li class="col-sm-3">
                                        员工：
                                        <select name="mailname" id="mailname" class="m-b">
                                            <option>全部</option>
                                        </select>
                                    </li>
                                    <li class="col-sm-3" style="margin: 0;">
                                        日期：<input type="text"　autocomplete="off" id="date" class="date" placeholder="时间" name="date">
                                    </li>
                                    <a class="btn btn-primary btn-rounded btn-sm" id="search"><i class="fa fa-search"></i>&nbsp;搜索</a>
                                    <a class="btn btn-warning btn-rounded btn-sm" id="downLoad" onclick=""><i class="fa fa-download"></i>&nbsp;导出</a>
                                </div>
                            </ul>
                        </div>
					</div>
				</form>
			</div>
			
	        <div class="btn-group-sm hidden-xs" id="toolbar" role="group">
                <div class="box-header box_bg">
                    <h3 class="box-title col-md-12" style="padding: 8px 0;">员工评价和画像功能</h3>
                </div>
			</div>
            <div id="main"></div>
		</div>
	</div>
    <div th:include="include :: footer"></div>
    <script th:inline="javascript">
        var editFlag = [[${@permission.hasPermi('system:jobdataall:edit')}]];
        var removeFlag = [[${@permission.hasPermi('system:jobdataall:remove')}]];
        var prefix = ctx + "bigdata/staff";
        //二级下拉列表
        var listproject = [[${depts}]];
        $(function() {
            var projectlist = [];
            projectlist.push("<option value=''>全部</option>");
            for (var i=0;i<listproject.length;i++) {
                projectlist.push("<option value='"+listproject[i].id+"'>"+listproject[i].department+"</option>");
            }
            $("#department").html(projectlist.join(""));
            // 群列表
            $("#department").change(function () {
                for (var i=0;i<listproject.length;i++) {
                    var charlist = [];
                    charlist.push("<option value=''>全部</option>");
                    if(listproject[i].id == $("#department").val()){
                        for (var j=0;j<listproject[i].employeeList.length;j++) {
                            charlist.push("<option value='"+listproject[i].employeeList[j].cn_name+"'>"+listproject[i].employeeList[j].cn_name+"</option>");
                        }
                        $("#mailname").html(charlist.join(""));
                        return;
                    }else{
                        $("#mailname").html(charlist.join(""));
                    }
                }
            });

            $("#search").click(function () {
                search();
            });
        });

        function search() {
            if (!$("#date").val()) {
                alert("请选择时间");
                return;
            }
            // $("#btn").bind("click",function() {
            //     var _url = prefix+"/showjson?department_id="
            //         + $("#department").val() + "&employee="
            //         + $("#mailname").val() + "&start_time="
            //         + $("#date").val();
                var _url = prefix+"/showjson";
                $.ajax({
                    type : "post",
                    url : _url,
                    data: {"department_id":$("#department").val(),"employee":$("#mailname").val(),"start_time":$("#date").val()},
                    // contentType : "application/json; charset=utf-8",
                    // dataType : 'text',
                    // async : false,
                    // globle : false,
                    error : function(data, status,error) {
                        console.log(data);
                        console.log(status);
                        console.log(error);
                    },
                    success : function(data) {
                        var node = [];
                        var link = [];
                        var data1 = [];
                        var data2 = [];
                        var data3 = [];
                        var data4 = [];
                        var jsonArray1 = new Array();
                        var jsonArray2 = new Array();
                        if (data   ==  "" ) {
                            alert("数据为空！");
                            $("#main").hide();
                            return false;
                        } else {
                            $("#main").show();
                        }
                        var	DT = eval("(" + data + ")");
                        data4 = DT[0].cnName;
                        //循环获取数据
                        for (var i = 1; i < DT.length; i++) {
                            data1[i] = DT[i].parentTagName;
                            if(DT[i].tagName=='唯一标识'){
                                data2[i] = ( '唯一标识，CN=' + DT[0].cnName);
                            }else{
                                data2[i] = (DT[i].tagName + '=' + DT[i].tagValue);
                            }
                            data3.push(data1[i]);
                            data3.push(data2[i]);
                            node.push({
                                category : 1,
                                name : data1[i],
                                value : 2,
                            });
                            node.push({
                                category : 2,
                                name : data2[i],
                                value : 1,
                            });
                            link.push({
                                source : data1[i],
                                target : data2[i],
                                weight : 1
                            });
                            link.push({
                                source : data4,
                                target : data1[i],
                                weight : 4
                            });
                        }
                        node.push({
                            category : 0,
                            name : data4,
                            value : 10,
                            symbol : 'image://yemian/images/calendar.jpg',
                            symbolSize : 30,
                            draggable : true,
                            itemStyle : {
                                normal : {
                                    label : {
                                        position : 'right',
                                        textStyle : {
                                            color : 'black'
                                        }
                                    }
                                }
                            }
                        });
                        var myChart = echarts.init(document.getElementById('main'));
                        option = {
                            /* title : {
                                text : '员工评价和画像功能',
                                x : 'center',
                                y : 'top'
                            }, */
                            tooltip : {
                                trigger : 'item',
                                formatter : '{a} : {b}'
                            },
                            toolbox : {
                                show : true,
                                feature : {
                                    saveAsImage : {
                                        show : true
                                    }
                                }
                            },
                            legend : {
                                x : 'left',
                                data : [ '一级标签',
                                    '二级标签' ]
                            },
                            series : [ {
                                type : 'force',
                                name : "员工指标",
                                ribbonType : false,
                                gravity : 0.35,
                                //scaling:1.5,
                                draggable : true,
                                linkSymbol : "arrow",
                                categories : [
                                    {
                                        name : '一级标签',
                                        itemStyle : {
                                            normal : {
                                                color : '#ff7f50'
                                            }
                                        }
                                    },
                                    {
                                        name : '二级标签',
                                        itemStyle : {
                                            normal : {
                                                color : '#87cefa'
                                            }
                                        }
                                    }

                                ],
                                itemStyle : {
                                    normal : {
                                        label : {
                                            show : true,
                                            textStyle : {
                                                color : '#333'
                                            },
                                        },
                                        nodeStyle : {
                                            brushType : 'both',
                                            borderColor : 'rgba(123,123,123,0.5)',
                                            borderWidth : 1
                                        }
                                    }
                                },
                                minRadius : 15,
                                maxRadius : 25,
                                coolDown : 0.995,
                                nodes : node,
                                links : link,
                                steps : 50
                            } ]
                        };
                        myChart.setOption(option);
                    }
                });
            // });
        }
    </script>
</body>
</html>